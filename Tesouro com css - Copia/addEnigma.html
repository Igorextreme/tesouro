<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adicionar Enigma</title>
  <link rel="stylesheet" href="css/addEnigma.css">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Press Start 2P', cursive;
    }

    #enigmaSection {
      padding: 20px;
    }

    #hostCode {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #f1f1f1;
      padding: 10px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      border-top: 2px solid #ddd;
    }

    #hostCode h2 {
      margin: 0;
      font-size: 20px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="enigmaSection">
    <h1>Adicionar Enigma</h1>
    
    <input type="text" id="codeInput" placeholder="Código do Enigma">
    <input type="text" id="questionInput" placeholder="Pergunta do Enigma">
    <input type="text" id="answerInput" placeholder="Resposta do Enigma">
    <button onclick="addEnigma()">Adicionar</button>
    <p id="addEnigmaMessage"></p>
  </div>

  <div id="hostCode">
    <h2 id="hostCodeText">Código do Host: Aguardando...</h2>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCB4R_ixloHBJSvVJEr69fPqnzEhdZjvVw",
      authDomain: "tesouro-1777a.firebaseapp.com",
      databaseURL: "https://tesouro-1777a-default-rtdb.firebaseio.com",
      projectId: "tesouro-1777a",
      storageBucket: "tesouro-1777a.appspot.com",
      messagingSenderId: "454369768010",
      appId: "1:454369768010:web:80b30f52686f7a8a19acb3",
      measurementId: "G-B5NQSMHK33"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    window.addEnigma = async function() {
      const code = document.getElementById('codeInput').value;
      const question = document.getElementById('questionInput').value;
      const answer = document.getElementById('answerInput').value;

      if (code && question && answer) {
        const user = auth.currentUser;

        if (user) {
          // Usar o UID do usuário para garantir um caminho válido
          const userRef = ref(db, `users/${user.uid}/enigmas/${code}`);

          try {
            await set(userRef, {
              question: question,
              answer: answer
            });
            document.getElementById('addEnigmaMessage').innerText = "Enigma adicionado com sucesso!";
            document.getElementById('addEnigmaMessage').style.color = 'green';
            
            // Atualizar o código do host na tela
            updateHostCode(user.uid);
          } catch (error) {
            console.error("Erro ao adicionar enigma:", error); // Adicionado para depuração
            document.getElementById('addEnigmaMessage').innerText = "Erro ao adicionar enigma: " + error.message;
            document.getElementById('addEnigmaMessage').style.color = 'red';
          }
        } else {
          document.getElementById('addEnigmaMessage').innerText = "Você deve estar logado para adicionar enigmas.";
          document.getElementById('addEnigmaMessage').style.color = 'red';
        }
      } else {
        document.getElementById('addEnigmaMessage').innerText = "Por favor, preencha todos os campos.";
        document.getElementById('addEnigmaMessage').style.color = 'red';
      }
    };

    async function updateHostCode(uid) {
      const hostCodeRef = ref(db, `users/${uid}/hostCode`);
      
      try {
        const snapshot = await get(hostCodeRef);
        if (snapshot.exists()) {
          const code = snapshot.val();
          document.getElementById('hostCodeText').innerText = `Código do Host: ${code}`;
          console.log("Código do Host:", code); // Adicionado para depuração
        } else {
          document.getElementById('hostCodeText').innerText = "Código do Host não encontrado.";
          console.log("Código do Host não encontrado."); // Adicionado para depuração
        }
      } catch (error) {
        document.getElementById('hostCodeText').innerText = "Erro ao obter o código do Host: " + error.message;
        console.error("Erro ao obter o código do Host:", error); // Adicionado para depuração
      }
    }
  </script>
</body>
</html>
