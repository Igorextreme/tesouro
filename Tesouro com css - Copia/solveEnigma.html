<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resolver Enigma</title>
  <link rel="stylesheet" href="css/solveEnigma.css">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <style>
    /* Estilos para o modal */
    .modal {
      display: none; /* Escondido por padrão */
      position: fixed; /* Fixo na tela */
      z-index: 1; /* Fica acima do conteúdo */
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto; /* Adiciona rolagem se necessário */
      background-color: rgb(0,0,0); /* Cor de fundo */
      background-color: rgba(0,0,0,0.4); /* Cor de fundo com transparência */
    }

    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%; /* Largura do modal */
      max-width: 500px;
      text-align: center;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    img.treasure-img {
      width: 100%;
      height: auto;
    }
  </style>
</head>
<body>
  <div id="keyCounter">
    <span id="keyIcon" class="material-symbols-outlined">key</span>
    <span id="keyCount">0</span>
  </div>
  
  <div id="solveSection">
    <h1>Resolver Enigma</h1>
    <input type="text" id="teamNameInput" placeholder="Nome da Equipe">
    <input type="text" id="codeSolveInput" placeholder="Código do Enigma">
    <button onclick="solveEnigma()">Gerar Enigma</button>
    <input type="text" id="answerSolveInput" placeholder="Resposta do Enigma" style="display:none;">
    <button onclick="submitAnswer()" style="display:none;">Enviar Resposta</button>
    <p id="solveEnigmaMessage"></p>
  </div>

  <!-- Modal -->
  <div id="treasureModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <img src="http://blogdebrinquedo.com.br/wp-content/uploads/2013/11/legendary_8-bit_treasure_chest.gif" class="treasure-img" alt="Tesouro">
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getDatabase, ref, get, child, update } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCB4R_ixloHBJSvVJEr69fPqnzEhdZjvVw",
      authDomain: "tesouro-1777a.firebaseapp.com",
      databaseURL: "https://tesouro-1777a-default-rtdb.firebaseio.com",
      projectId: "tesouro-1777a",
      storageBucket: "tesouro-1777.appspot.com",
      messagingSenderId: "454369768010",
      appId: "1:454369768010:web:80b30f52686f7a8a19acb3",
      measurementId: "G-B5NQSMHK33"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Função para atualizar o contador de chaves
    function updateKeyCounter() {
      const teamName = localStorage.getItem('teamName');
      const hostCode = localStorage.getItem('hostCode');

      if (teamName && hostCode) {
        const dbRef = ref(db);
        get(child(dbRef, `users`))
          .then((snapshot) => {
            snapshot.forEach((userSnapshot) => {
              const userData = userSnapshot.val();
              if (userData.hostCode === hostCode) {
                get(child(dbRef, `users/${userSnapshot.key}/teams/${teamName}`))
                  .then((teamSnapshot) => {
                    if (teamSnapshot.exists()) {
                      const keys = teamSnapshot.val().keys || 0;
                      document.getElementById('keyCount').innerText = keys;
                    } else {
                      document.getElementById('keyCount').innerText = '0';
                    }
                  });
              }
            });
          })
          .catch((error) => {
            console.error("Erro ao acessar os dados das equipes: ", error.message);
          });
      }
    }

    window.solveEnigma = function() {
      const teamName = document.getElementById('teamNameInput').value;
      const code = document.getElementById('codeSolveInput').value;
      const hostCode = localStorage.getItem('hostCode'); // Recupera o código do host armazenado

      if (teamName && code) {
        if (hostCode) {
          // Armazenar o nome da equipe no localStorage
          localStorage.setItem('teamName', teamName);

          const dbRef = ref(db);
          get(child(dbRef, `users`))
            .then((snapshot) => {
              let enigmaFound = false;
              snapshot.forEach((userSnapshot) => {
                const userData = userSnapshot.val();
                if (userData.hostCode === hostCode) {
                  get(child(dbRef, `users/${userSnapshot.key}/enigmas/${code}`))
                    .then((enigmaSnapshot) => {
                      if (enigmaSnapshot.exists()) {
                        const enigma = enigmaSnapshot.val();
                        document.getElementById('solveEnigmaMessage').innerText = enigma.question;
                        document.getElementById('solveEnigmaMessage').style.color = 'blue';
                        document.getElementById('answerSolveInput').style.display = 'block';
                        document.querySelector('button[onclick="submitAnswer()"]').style.display = 'block';
                        enigmaFound = true;
                      } else {
                        document.getElementById('solveEnigmaMessage').innerText = "Enigma não encontrado.";
                        document.getElementById('solveEnigmaMessage').style.color = 'red';
                        document.getElementById('answerSolveInput').style.display = 'none';
                        document.querySelector('button[onclick="submitAnswer()"]').style.display = 'none';
                      }
                    })
                    .catch((error) => {
                      document.getElementById('solveEnigmaMessage').innerText = "Erro ao buscar enigma: " + error.message;
                      document.getElementById('solveEnigmaMessage').style.color = 'red';
                      document.getElementById('answerSolveInput').style.display = 'none';
                      document.querySelector('button[onclick="submitAnswer()"]').style.display = 'none';
                    });
                }
              });
              if (!enigmaFound) {
                document.getElementById('solveEnigmaMessage').innerText = "Código do host inválido.";
                document.getElementById('solveEnigmaMessage').style.color = 'red';
                document.getElementById('answerSolveInput').style.display = 'none';
                document.querySelector('button[onclick="submitAnswer()"]').style.display = 'none';
              }
            })
            .catch((error) => {
              document.getElementById('solveEnigmaMessage').innerText = "Erro ao acessar os dados dos usuários: " + error.message;
              document.getElementById('solveEnigmaMessage').style.color = 'red';
              document.getElementById('answerSolveInput').style.display = 'none';
              document.querySelector('button[onclick="submitAnswer()"]').style.display = 'none';
            });
        } else {
          document.getElementById('solveEnigmaMessage').innerText = "Código do host não encontrado. Você deve fazer login novamente.";
          document.getElementById('solveEnigmaMessage').style.color = 'red';
        }
      } else {
        document.getElementById('solveEnigmaMessage').innerText = "Por favor, insira o nome da equipe e o código do enigma.";
        document.getElementById('solveEnigmaMessage').style.color = 'red';
      }
    };

    window.submitAnswer = function() {
      const teamName = localStorage.getItem('teamName'); // Recupera o nome da equipe armazenado
      const code = document.getElementById('codeSolveInput').value;
      const answer = document.getElementById('answerSolveInput').value;
      const hostCode = localStorage.getItem('hostCode'); // Recupera o código do host armazenado

      if (teamName && code && answer) {
        if (hostCode) {
          const dbRef = ref(db);
          get(child(dbRef, `users`))
            .then((snapshot) => {
              let teamFound = false;
              snapshot.forEach((userSnapshot) => {
                const userData = userSnapshot.val();
                if (userData.hostCode === hostCode) {
                  get(child(dbRef, `users/${userSnapshot.key}/enigmas/${code}`))
                    .then((enigmaSnapshot) => {
                      if (enigmaSnapshot.exists()) {
                        const enigma = enigmaSnapshot.val();
                        if (enigma.answer === answer) {
                          document.getElementById('solveEnigmaMessage').innerText = "Resposta correta! Sua equipe ganhou uma chave.";
                          document.getElementById('solveEnigmaMessage').style.color = 'green';

                          get(child(dbRef, `users/${userSnapshot.key}/teams/${teamName}`))
                            .then((teamSnapshot) => {
                              if (teamSnapshot.exists()) {
                                let keys = teamSnapshot.val().keys || 0;
                                keys++;
                                update(ref(db, `users/${userSnapshot.key}/teams/${teamName}`), { keys })
                                  .then(() => {
                                    updateKeyCounter(); // Atualiza o contador de chaves
                                    if (keys >= 3) {
                                      showTreasureModal(); // Exibe o modal do tesouro
                                    }
                                  });
                              }
                            });
                        } else {
                          document.getElementById('solveEnigmaMessage').innerText = "Resposta incorreta. Tente novamente.";
                          document.getElementById('solveEnigmaMessage').style.color = 'red';
                        }
                      } else {
                        document.getElementById('solveEnigmaMessage').innerText = "Enigma não encontrado.";
                        document.getElementById('solveEnigmaMessage').style.color = 'red';
                      }
                    })
                    .catch((error) => {
                      document.getElementById('solveEnigmaMessage').innerText = "Erro ao verificar a resposta: " + error.message;
                      document.getElementById('solveEnigmaMessage').style.color = 'red';
                    });
                }
              });
            })
            .catch((error) => {
              document.getElementById('solveEnigmaMessage').innerText = "Erro ao acessar os dados das equipes: " + error.message;
              document.getElementById('solveEnigmaMessage').style.color = 'red';
            });
        } else {
          document.getElementById('solveEnigmaMessage').innerText = "Código do host não encontrado. Você deve fazer login novamente.";
          document.getElementById('solveEnigmaMessage').style.color = 'red';
        }
      } else {
        document.getElementById('solveEnigmaMessage').innerText = "Por favor, insira o nome da equipe, o código do enigma e a resposta.";
        document.getElementById('solveEnigmaMessage').style.color = 'red';
      }
    };

    function showTreasureModal() {
      const modal = document.getElementById('treasureModal');
      const span = document.getElementsByClassName('close')[0];
      modal.style.display = 'block';

      span.onclick = function() {
        modal.style.display = 'none';
      }

      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      }
    }

    // Inicializa o contador de chaves ao carregar a página
    document.addEventListener('DOMContentLoaded', () => {
      updateKeyCounter();
    });
  </script>
</body>
</html>
